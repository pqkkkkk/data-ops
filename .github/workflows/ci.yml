name: CI - Test DBT Models

on:
  pull_request:
    branches:
      - main
      - develop
      - etl
    paths:
      - 'dbt/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  dbt-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install ODBC Driver for SQL Server
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

      - name: Start SQL Server (Custom Image)
        run: |
          docker compose up -d --build sqlserver
          
          echo "Waiting for SQL Server to be ready..."
          
          for i in {1..60}; do
            if docker exec $(docker compose ps -q sqlserver) /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q "SELECT 1" &> /dev/null; then
              echo "SQL Server is up!"
              if docker exec $(docker compose ps -q sqlserver) /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q "SELECT name FROM sys.databases WHERE name = 'AdventureWorks2014'" | grep -q "AdventureWorks2014"; then
                 echo "AdventureWorks2014 database is ready!"
                 exit 0
              fi
              echo "Database restoring..."
            else 
              echo "Waiting for connection..."
            fi
            sleep 2
          done
          echo "Timeout waiting for SQL Server"
          exit 1
      
      - name: Install DBT and dependencies
        run: |
          pip install dbt-sqlserver
          cd dbt
          dbt deps
      
      - name: DBT Debug
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt debug --profiles-dir .
      
      - name: Compile DBT models
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt compile --profiles-dir .
      
      - name: Run DBT models
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt run --profiles-dir . --target dev
      
      - name: Test DBT models
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt test --profiles-dir . --target dev
      
      - name: Generate DBT docs
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt docs generate --profiles-dir .
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-test-results
          path: dbt/target/*.json
      
      - name: Cleanup SQL Server
        if: always()
        run: |
          docker compose down -v

  lint-python:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install linting tools
        run: |
          pip install flake8 black
      
      - name: Run flake8
        run: |
          flake8 airflow/dags/ --max-line-length=120 --exclude=__pycache__
      
      - name: Check code formatting with black
        run: |
          black --check airflow/dags/

  lint-sql:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install sqlfluff
        run: |
          pip install sqlfluff sqlfluff-templater-dbt
      
      - name: Lint SQL files
        run: |
          cd dbt
          sqlfluff lint models/ --dialect tsql
