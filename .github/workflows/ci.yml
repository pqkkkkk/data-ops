name: CI - Test DBT Models

on:
  pull_request:
    branches:
      - main
      - develop
      - etl
    paths:
      - 'dbt/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  dbt-test:
    runs-on: ubuntu-latest
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: YourStrong@Passw0rd
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1' -C"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 60s
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install ODBC Driver for SQL Server
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev
      
      - name: Install DBT and dependencies
        run: |
          pip install dbt-sqlserver
          cd dbt
          dbt deps
      
      - name: DBT Debug
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt debug --profiles-dir .
      
      - name: Compile DBT models
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt compile --profiles-dir .
      
      - name: Run DBT models
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt run --profiles-dir . --target dev
      
      - name: Test DBT models
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt test --profiles-dir . --target dev
      
      - name: Generate DBT docs
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt docs generate --profiles-dir .
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-test-results
          path: dbt/target/*.json

  lint-python:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install linting tools
        run: |
          pip install flake8 black
      
      - name: Run flake8
        run: |
          flake8 airflow/dags/ --max-line-length=120 --exclude=__pycache__
      
      - name: Check code formatting with black
        run: |
          black --check airflow/dags/

  lint-sql:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install sqlfluff
        run: |
          pip install sqlfluff sqlfluff-templater-dbt
      
      - name: Lint SQL files
        run: |
          cd dbt
          sqlfluff lint models/ --dialect tsql
