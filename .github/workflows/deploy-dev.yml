name: Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://github.com/${{ github.repository }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install ODBC Driver for SQL Server
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

      - name: Start SQL Server (Simulate Dev Environment)
        run: |
          docker compose up -d --build sqlserver
          
          echo "Waiting for SQL Server to be ready..."
          sleep 30 # Đợi khởi động cơ bản
          
          for i in {1..60}; do
            if docker exec $(docker compose ps -q sqlserver) /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q "SELECT name FROM sys.databases WHERE name = 'AdventureWorks2014'" | grep -q "AdventureWorks2014"; then
                 echo "Development Database is ready!"
                 exit 0
            fi
            echo "Waiting for database restore..."
            sleep 2
          done
          exit 1
      
      - name: Install DBT
        run: pip install dbt-sqlserver
      
      - name: Install DBT dependencies
        run: |
          cd dbt
          dbt deps
      
      - name: Run DBT models (Development)
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt run --profiles-dir . --target dev
      
      - name: Run DBT tests
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt test --profiles-dir . --target dev

      - name: Generate DBT documentation
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt docs generate --profiles-dir . --target dev

      - name: Upload DBT documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs-development
          path: dbt/target/docs

      # Deployment Notification
      - name: Deployment Success Notification
        if: success()
        run: |
          echo "✅ Deployment to Development successful!"