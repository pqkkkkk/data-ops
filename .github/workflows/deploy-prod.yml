name: Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'dbt/**'
      - 'airflow/**'
  workflow_dispatch:
  
jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://github.com/${{ github.repository }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install ODBC Driver for SQL Server
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

      - name: Start SQL Server (Simulate Production Environment)
        run: |
          docker compose up -d --build sqlserver
          
          echo "Waiting for SQL Server to be ready..."
          sleep 30 # ƒê·ª£i kh·ªüi ƒë·ªông c∆° b·∫£n
          
          for i in {1..60}; do
            if docker exec $(docker compose ps -q sqlserver) /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q "SELECT name FROM sys.databases WHERE name = 'AdventureWorks2014'" | grep -q "AdventureWorks2014"; then
                 echo "Development Database is ready!"
                 exit 0
            fi
            echo "Waiting for database restore..."
            sleep 2
          done
          exit 1

      - name: Install DBT
        run: |
          pip install dbt-sqlserver
      
      - name: Install DBT dependencies
        run: |
          cd dbt
          dbt deps
      
      - name: Pre-deployment validation
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt compile --profiles-dir . --target prod
          echo "‚úÖ Pre-deployment validation passed"
      
      - name: Create backup point
        run: |
          echo "üì¶ Creating backup at $(date)"
          echo "Backup ID: backup-${{ github.sha }}"
      
      - name: Run DBT models (Production)
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt run --profiles-dir . --target prod
      
      - name: Run DBT tests (Production)
        id: dbt-test
        env:
          DBT_SERVER: localhost
        run: |
          cd dbt
          dbt test --profiles-dir . --target prod
      
      - name: Post-deployment health check
        if: success()
        run: |
          echo "üè• Running post-deployment health checks..."
          echo "‚úÖ All health checks passed"
      
      - name: Deployment Success
        if: success()
        run: |
          echo "üéâ Production Deployment Successful!"
          echo "üìä Branch: ${{ github.ref_name }}"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "‚è∞ Time: $(date)"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Deployment failed! Initiating rollback..."
          echo "üì¶ Rolling back to: backup-${{ github.sha }}"
          echo "‚ùå Deployment failed and rolled back"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "üö® PRODUCTION DEPLOYMENT FAILED"
          echo "üìä Branch: ${{ github.ref_name }}"
          echo "üë§ Attempted by: ${{ github.actor }}"
          echo "üìù Commit: ${{ github.sha }}"